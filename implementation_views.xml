<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <record id="view_project_implementation_form" model="ir.ui.view">
    <field name="name">project.implementation.form</field>
    <field name="model">project.implementation</field>
    <field name="arch" type="xml">
      <form string="Implementare proiect" class="o_form_full">
        <sheet class="o_form_sheet_full">

          <!-- 2 coloane in header (deasupra notebook) -->
          <group col="2">
            <!-- Stanga: campurile existente -->
            <group>
              <field name="name" readonly="1"/>
              <field name="funding_project_id" readonly="1"/>
              <field name="beneficiar_name" readonly="1"/>
              <field name="beneficiar_cui" readonly="1"/>
              <field name="user_id"/>
              <field name="state"/>
            </group>

            <!-- Dreapta: perioada implementare (EDITABILE) -->
            <group string="Perioadă implementare">
              <field name="start_date"/>
              <field name="end_date"/>
            </group>
          </group>

          <notebook>
            <page string="Devize">
              <group>
                <button name="action_sync_budget_from_funding"
                        type="object"
                        class="btn-primary"
                        string="Sincronizează din funding"/>
              </group>

              <field name="budget_proxy_line_ids" nolabel="1">
                <list create="0" delete="0"
                      decoration-danger="sold_total &lt; 0 or neramb_minus_settled &lt; 0">
                  <button name="action_open_details" type="object" string="Detalii" class="btn-secondary"/>

                  <field name="chapter"/>
                  <field name="subchapter"/>
                  <field name="name"/>

                  <field name="total_eligibil"/>
                  <field name="total_neeligibil"/>

                  <field name="contract_total" readonly="1"/>

                  <field name="documents_elig_total" readonly="1"/>
                  <field name="documents_neelig_total" readonly="1"/>
                  <field name="documents_total" readonly="1"/>

                  <field name="sold_total" readonly="1"/>

                  <field name="neramb_total" readonly="1"/>

                  <field name="settlements_total" readonly="1"/>
                  <field name="neramb_minus_settled" readonly="1"/>
                </list>
              </field>

              <div class="o_form_label text-muted">
                Devizul de bază este read-only din funding. Coloanele sunt calculate automat din contracte, documente și decontări.
                Rândurile sunt marcate cu roșu când există depășiri (Sold &lt; 0 sau Neramb - Decontat &lt; 0).
              </div>
            </page>

            <page string="Activități">
              <group>
                <button name="action_sync_activities_from_funding"
                        type="object"
                        class="btn-primary"
                        string="Sincronizează din funding"/>
              </group>

              <field name="activity_proxy_line_ids" nolabel="1">
                <list create="0" delete="0">
                  <field name="sequence"/>
                  <field name="name"/>
                  <field name="date_start"/>
                  <field name="date_end"/>
                  <field name="min_contract_date"/>
                  <field name="max_contract_date"/>
                </list>
              </field>

              <div class="o_form_label text-muted">
                Activitățile sunt read-only din funding. Coloanele “Min contract / Max contract” sunt calculate pe baza
                contractelor din implementare care au setată activitatea (funding).
              </div>
            </page>

            <page string="Achiziții">
              <group>
                <button name="action_sync_acquisitions_from_funding"
                        type="object"
                        class="btn-primary"
                        string="Sincronizează din funding"/>
              </group>

              <field name="acquisition_proxy_line_ids" nolabel="1">
                <list create="0" delete="0">
                  <field name="sequence"/>
                  <field name="code"/>
                  <field name="name"/>
                  <field name="date_start"/>
                  <field name="date_end"/>
                  <field name="deviz_baza"/>
                  <field name="deviz_tva"/>
                  <field name="amount_contracted_base"/>
                  <field name="amount_contracted_vat"/>
                </list>
              </field>

              <div class="o_form_label text-muted">
                Achizițiile sunt read-only din funding. Coloanele “Contractat bază/TVA” aparțin implementării și
                sunt calculate pe baza contractelor care au setată achiziția (funding).
              </div>
            </page>

            <page string="Contracte">
              <field name="contract_ids" nolabel="1"
                     context="{'form_view_ref': 'project_implementation.view_project_contract_form_header'}">
                <list create="1" delete="1">
                  <button name="action_open_details" type="object" string="Detalii" class="btn-secondary"/>
                  <button name="action_open_files" type="object" string="Fișiere" class="btn-secondary"/>
                  <button name="action_add_file" type="object" string="Adaugă fișier" class="btn-primary"/>

                  <field name="award_state"/>
                  <field name="contract_number"/>
                  <field name="contract_date"/>
                  <field name="supplier_name"/>
                  <field name="contract_type"/>
                  <field name="procedure_type"/>
                  <field name="seap_number"/>
                  <field name="seap_date"/>
                  <field name="start_date"/>
                  <field name="end_date"/>
                  <field name="amount_total"/>
                </list>
              </field>
            </page>

            <page string="Documente">
              <field name="document_ids" nolabel="1"
                     context="{'form_view_ref': 'project_implementation.view_project_document_form_header'}">
                <list create="1" delete="1">
                  <button name="action_open_details" type="object" string="Detalii" class="btn-secondary"/>
                  <button name="action_open_files" type="object" string="Fișiere" class="btn-secondary"/>
                  <button name="action_add_file" type="object" string="Adaugă fișier" class="btn-primary"/>

                  <field name="document_type"/>
                  <field name="document_number"/>
                  <field name="document_date"/>
                  <field name="issuer_name"/>
                  <field name="contract_id"/>
                  <field name="amount_elig_base_total"/>
                  <field name="amount_elig_vat_total"/>
                  <field name="amount_neelig_base_total"/>
                  <field name="amount_neelig_vat_total"/>
                  <field name="amount_total"/>
                </list>
              </field>
            </page>

            <page string="Decontări">
              <field name="settlement_ids" nolabel="1"
                     context="{'form_view_ref': 'project_implementation.view_project_settlement_form_header'}">
                <list create="1" delete="1">
                  <button name="action_open_details" type="object" string="Detalii" class="btn-secondary"/>

                  <field name="settlement_number"/>
                  <field name="settlement_date"/>
                  <field name="notes" readonly="1"/>
                  <field name="aport_valoare" readonly="1"/>
                  <field name="amount_elig_base_total" readonly="1"/>
                  <field name="amount_elig_vat_total" readonly="1"/>
                  <field name="amount_total" readonly="1"/>
                </list>
              </field>
            </page>

            <page string="Situații">
              <group>
                <button name="action_export_situatii_xlsx"
                        type="object"
                        class="btn-primary"
                        string="Export Proiect (xlsx)"/>
		<button name="action_export_situatii_xlsx_total"
        		type="object"
        		class="btn-secondary"
        		string="Export TOTAL (xlsx)"/>
              </group>

              <div class="o_form_label text-muted">
                Exportă un fișier Excel cu 4 taburi: Deviz, Contracte, Documente și Decontări.
              </div>
            </page>

            <page string="Fișiere">
              <group>
                <button name="action_open_files_manager"
                        type="object"
                        class="btn-primary"
                        string="Management fișiere (proiect)"/>
              </group>

              <field name="file_ids" nolabel="1">
                <list create="1" delete="1">
                  <field name="category"/>
                  <field name="original_filename"/>
                  <field name="standard_filename"/>
                  <field name="note"/>
                  <field name="stored_path" readonly="1"/>
                  <button name="action_download" type="object" string="Download" class="btn-secondary"/>
                </list>
              </field>

              <div class="o_form_label text-muted">
                Fișierele sunt salvate pe server în folderul: &lt;ROOT&gt;\&lt;COD_PROIECT&gt;\... (ROOT = project_implementation.files_root).
              </div>
            </page>

          </notebook>

        </sheet>
      </form>
    </field>
  </record>

</odoo>